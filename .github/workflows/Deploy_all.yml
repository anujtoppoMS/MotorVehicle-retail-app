name: CD - Deploy all

on:
  workflow_dispatch:
  workflow_call:


jobs:

  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Set up Kubectl
      uses: azure/setup-kubectl@v4

    - name: Set Context for Kubernetes
      uses: Azure/k8s-set-context@v4
      with:
        kubeconfig: ${{ secrets.KUBE_CONFIG }}

    - name: Encode Secrets in Base64
      run: |
        echo "DJANGO_SECRET_KEY=$(echo -n '${{ secrets.DJANGO_SECRET_KEY }}' | base64)" >> $GITHUB_ENV
        echo "POSTGRES_PASSWORD=$(echo -n '${{ secrets.POSTGRES_PASSWORD }}' | base64)" >> $GITHUB_ENV
        echo "EMAIL_HOST_USER=$(echo -n '${{ secrets.EMAIL_HOST_USER }}' | base64)" >> $GITHUB_ENV
        echo "ENCRYPTED_EMAIL_PASSWORD=$(echo -n '${{ secrets.ENCRYPTED_EMAIL_PASSWORD }}' | base64)" >> $GITHUB_ENV
      
    - name: Check for ConfigMap and required secrets
      run: |
        kubectl -n dev apply -f menifest/app/cm-billing-app.yaml
        kubectl -n dev apply -f menifest/proxy/proxy_cm.yaml
        kubectl -n dev apply -f menifest/app/billing-app-secret.yaml
        kubectl -n dev apply -f menifest/db/db_secret.yaml
        
      env:
        DJANGO_SECRET_KEY: ${{ env.DJANGO_SECRET_KEY }}
        DJANGO_SUPERUSER_USERNAME: ${{ env.DJANGO_SUPERUSER_USERNAME }}
        DJANGO_SUPERUSER_EMAIL: ${{ env.DJANGO_SUPERUSER_EMAIL }}
        POSTGRES_ENGINE: 'django.db.backends.postgresql'
        POSTGRES_DB: 'postgres'
        POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        POSTGRES_USER: 'postgres'
        POSTGRES_HOST: 'db-service'
        POSTGRES_PORT: '5432'
        EMAIL_HOST_USER: ${{ env.EMAIL_HOST_USER }}
        ENCRYPTED_EMAIL_PASSWORD: ${{ env.ENCRYPTED_EMAIL_PASSWORD }}
        ALLOWED_HOSTS: 'localhost,127.0.0.1,0.0.0.0,billingsystem'
        CSRF_TRUSTED_ORIGINS: 'http://localhost:8080,http://127.0.0.1'
        SERVER_NAME: 'billingsystem'
        SERVER_PORT: '8000'
        
    - name: Deploy DB
      uses: Azure/k8s-deploy@v4
      with:
        action: deploy
        manifests: | 
          menifest/db/db.yaml 
        namespace: dev

    - name: Deploy Billing App
      uses: Azure/k8s-deploy@v4
      with:
        action: deploy
        manifests: |
          menifest/app/billing-app.yaml
        namespace: dev
        
    - name: Deploy Proxy
      uses: Azure/k8s-deploy@v4
      with:
        action: deploy
        manifests: |
          menifest/proxy/proxy.yaml
        namespace: dev
          
    - name: Verify Deployment 
      run: | 
        kubectl rollout status deployment/billingsystem -n dev
        kubectl rollout status deployment/proxy -n dev